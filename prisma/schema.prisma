generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                String         @id @default(auto()) @map("_id") @db.ObjectId
  username          String
  password          String
  passwordExpiresAt DateTime
  sessions          Session[]
  calificaciones    Calificacion[]
}

model Session {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)
  expiresAt DateTime
  username  String
}

enum EspecialidadDespacho {
  Promiscuo
  Penal
  PenalAdolescentes
  PenalConocimiento
  PenalGarantias
  PenalMixto
  EjecucionPenas
  Civil
  Familia
  FamiliaPromiscuo
  Laboral
  Administrativo
}

enum CategoriaDespacho {
  Municipal
  Circuito
  Tribunal
}

model Despacho {
  id                    String                 @id @default(auto()) @map("_id") @db.ObjectId
  codigo                String
  nombre                String
  numero                Int?
  especialidad          EspecialidadDespacho?
  categoria             CategoriaDespacho?
  municipio             String?
  distrito              String?
  registrosCalificacion RegistroCalificacion[]
  registrosAudiencias   RegistroAudiencias[]
  calificaciones        Calificacion[]
}

model Funcionario {
  id                    String                 @id @default(auto()) @map("_id") @db.ObjectId
  documento             String
  nombre                String
  novedades             NovedadFuncionario[]
  registrosCalificacion RegistroCalificacion[]
  calificaciones        Calificacion[]
}

type NovedadFuncionario {
  days  Int
  from  DateTime @db.Date
  notes String
  to    DateTime @db.Date
  type  String
}

enum ClaseRegistroCalificacion {
  oral
  constitucional
  escrito
  garantias
  otros
}

model RegistroAudiencias {
  id                      String         @id @default(auto()) @map("_id") @db.ObjectId
  periodo                 Int // Año del registro
  despachoId              String         @db.ObjectId
  despacho                Despacho       @relation(fields: [despachoId], references: [id])
  programadas             Int
  atendidas               Int
  aplazadasAjenas         Int
  aplazadasJustificadas   Int
  aplazadasNoJustificadas Int
  calificacion            Calificacion[]

  @@unique([despachoId, periodo])
}

model RegistroCalificacion {
  id                String                    @id @default(auto()) @map("_id") @db.ObjectId
  periodo           Int // Año del registro
  despachoId        String                    @db.ObjectId
  despacho          Despacho                  @relation(fields: [despachoId], references: [id])
  funcionarioId     String                    @db.ObjectId
  funcionario       Funcionario               @relation(fields: [funcionarioId], references: [id])
  clase             ClaseRegistroCalificacion
  categoria         String
  desde             DateTime                  @db.Date
  hasta             DateTime                  @db.Date
  dias              Int?
  inventarioInicial Int
  ingresoEfectivo   Int
  cargaEfectiva     Int
  egresoEfectivo    Int
  conciliaciones    Int
  inventarioFinal   Int
  restan            Int
  calificacionId    String?                   @db.ObjectId
  calificacion      Calificacion?             @relation(fields: [calificacionId], references: [id], onDelete: Cascade)
}

model CalificacionSubfactor {
  id                               String                    @id @default(auto()) @map("_id") @db.ObjectId
  subfactor                        ClaseRegistroCalificacion
  totalInventarioInicial           Int
  cargaBaseCalificacionDespacho    Float
  cargaBaseCalificacionFuncionario Float
  egresoFuncionario                Int
  cargaProporcional                Float
  totalSubfactor                   Float
  calificacionId                   String?                   @db.ObjectId
  calificacion                     Calificacion?             @relation(fields: [calificacionId], references: [id], onDelete: Cascade)
}

enum EstadoCalificacion {
  borrador
  revision
  aprobado
}

model Calificacion {
  id                                String                  @id @default(auto()) @map("_id") @db.ObjectId
  estado                            EstadoCalificacion
  periodo                           Int // Año del registro
  funcionarioId                     String                  @db.ObjectId
  funcionario                       Funcionario             @relation(fields: [funcionarioId], references: [id])
  despachoId                        String                  @db.ObjectId
  despacho                          Despacho                @relation(fields: [despachoId], references: [id])
  diasHabilesDespacho               Int
  diasDescontados                   Int
  diasLaborados                     Int
  registrosConsolidados             RegistroCalificacion[] // registros con categoria "Consolidado"
  subfactores                       CalificacionSubfactor[]
  registroAudienciasId              String                  @db.ObjectId
  registroAudiencias                RegistroAudiencias      @relation(fields: [registroAudienciasId], references: [id])
  calificacionAudiencias            Float
  factorOralMasAudiencias           Float
  calificacionTotalFactorEficiencia Float
  createdAt                         DateTime                @default(now()) @db.Date
  createdById                       String                  @db.ObjectId
  createdBy                         User                    @relation(fields: [createdById], references: [id])

  @@unique([despachoId, funcionarioId, periodo])
}
